<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Crypto Alarm Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
       
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 32, 39, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .auth-header {
            margin-bottom: 25极px;
        }
        
        .auth-header h2 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .auth-tab {
            padding: 12px 30px;
            cursor: pointer;
            border-radius: 30px;
            margin: 0 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            background: linear-gradient(90deg, #00c9极ff, #92fe9d);
            color: #0f2027;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
            color: #92fe9d;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            border-color: #00c9ff;
            box-shadow: 0 0 10px rgba(0, 201, 255, 0.5);
            outline: none;
        }
        
        .auth-btn {
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            color: #0f2027;
            border: none;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .auth-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 201, 255, 0.4);
        }
        
        .error-message {
            color: #ff416c;
            margin-top: 10px;
            font-size: 0.9rem;
            min-height: 20px;
        }
        
        .success-message {
            color: #92fe9d;
            margin-top: 10px;
            font-size: 0.9rem;
            min-height: 20px;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 8px 15px;
            backdrop-filter: blur(5px);
        }
        
        .user-info span {
            margin-right: 10px;
            font-weight: 500;
        }
        
        .logout-btn {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 65, 108, 0.5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: none; /* Initially hidden until auth */
        }
       
        header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }
       
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
       
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }
       
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }
       
        .controls {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
       
        .control-group {
            margin-bottom: 10px;
        }
       
        h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #00c9ff;
        }
       
        .form-group {
            margin-bottom: 12px;
        }
       
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #92fe9d;
            font-size: 0.95rem;
        }
       
        select, input[type="number"], input[type="file"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
        }
       
        select:focus, input:focus {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 2px #00c9ff;
        }
       
        select option {
            background: #2c5364;
        }
       
        .alarm-type {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
       
        .alarm-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
       
        .alarm-type label:hover {
            background: rgba(255, 255, 255, 0.15);
        }
       
        .alarm-type input[type="radio"] {
            display: none;
        }
       
        .alarm-type input[type="radio"]:checked + span {
            color: #00c9ff;
            font-weight: 600;
        }
       
        .btn {
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            color: #0f2027;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }
       
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 201, 255, 0.4);
        }
       
        .btn:active {
            transform: translateY(0);
        }
       
        .btn-stop {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            margin-top: 8px;
        }
       
        .btn-secondary {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
        }
       
        .alarm-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            overflow: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            max-height: 500px;
        }
       
        .alarm-table::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
       
        .alarm-table::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
       
        .alarm-table::-webkit-scrollbar-thumb {
            background: #00c9ff;
            border-radius: 4px;
        }
       
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
       
        th {
            background: rgba(0, 201, 255, 0.2);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            position: sticky;
            top: 0;
        }
       
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
       
        tr:last-child td {
            border-bottom: none;
        }
       
        .price-display {
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }
       
        .price-up {
            color: #92fe9d;
        }
       
        .price-down {
            color: #ff416c;
        }
       
        .alarm-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
       
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff416c;
        }
       
        .status-active {
            background: #92fe9d;
            animation: pulse 1.5s infinite;
        }
       
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
       
        footer {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
        }
       
        .alarm-active {
            background: rgba(255, 65, 108, 0.15);
            animation: alarmFlash 1s infinite;
        }
       
        @keyframes alarmFlash {
            0% { background: rgba(255, 65, 108, 0.15); }
            50% { background: rgba(255, 65, 108, 0.3); }
            100% { background: rgba(255, 65, 108, 0.15); }
        }
       
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-size: 0.95rem;
        }
       
        .notification.show {
            transform: translateX(0);
        }
       
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
       
        .volume-icon {
            font-size: 1.1rem;
            color: #00c9ff;
        }
       
        .percentage-input {
            display: flex;
            gap: 10px;
        }
       
        .percentage-input input {
            flex: 1;
        }
       
        .percentage-input select {
            width: 100px;
        }
       
        .sound-test {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }
       
        .sound-test-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 5px;
        }
       
        .sound-test-btn {
            padding: 6px 12px;
            min-width: 80px;
        }
       
        .action-buttons {
            display: flex;
            gap: 8px;
        }
       
        .action-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-width: 70px;
        }
       
        .save-load-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
       
        .save-load-controls .btn {
            width: auto;
            flex: 1;
            padding: 8px 12px;
        }
       
        .executed-status {
            color: #00c9ff;
            font-weight: 600;
        }
       
        .executed-yes {
            color: #92fe9d;
        }
       
        .executed-no {
            color: #ff416c;
        }
       
        .delete-btn {
            background: transparent;
            border: none;
            color: #ff416c;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
       
        .delete-btn:hover {
            background: rgba(255, 65, 108, 0.2);
            transform: scale(1.1);
        }
       
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
           
            h1 {
                font-size: 2rem;
            }
        }
       
        @media (max-width: 500px) {
            .alarm-type {
                flex-direction: column;
                gap: 8px;
            }
           
            .action-buttons {
                flex-direction: column;
            }
           
            .action-btn {
                width: 100%;
            }
           
            .sound-test-buttons {
                flex-direction: column;
            }
           
            .sound-test-btn {
                width: 100%;
            }
        }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00c9ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1001;
        }
        
        .status-message {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 65, 108, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status-message.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-container">
            <div class="auth-header">
                <h2><i class="fas fa-lock"></i> Crypto Alarm Tracker</h2>
                <p>Access your personalized alarms</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">Login</div>
                <div class="auth-tab" id="signup-tab">Sign Up</div>
            </div>
            
            <div class="auth-form active" id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                
                <div class="error-message" id="login-error"></div>
                
                <button class="auth-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
            
            <div class="auth-form" id="signup-form">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                </div>
                
                <div class="form-group">
                    <label for="signup-confirm">Confirm Password</label>
                    <input type="password" id="signup-confirm" placeholder="Confirm your password">
                </div>
                
                <div class="error-message" id="signup-error"></div>
                <div class="success-message" id="signup-success"></div>
                
                <button class="auth-btn" id="signup-btn">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
        </div>
    </div>
    
    <!-- Status Message -->
    <div class="status-message" id="status-message"></div>
    
    <!-- User Info Bar -->
    <div class="user-info" id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="logout-btn" id="logout-btn">
            <i class="fas fa-sign-out-alt"></极> Logout
        </button>
    </div>
    
    <!-- Main App Container -->
    <div class="container" id="app-container">
        <header>
            <h1><i class="fas fa-bell"></i> Enhanced Crypto Alarm Tracker</h1>
            <p class="subtitle">Real-time cryptocurrency price alerts with advanced features</p>
        </header>
       
        <div class="dashboard">
            <div class="controls">
                <div class="control-group">
                    <h2><i class="fas fa-cog"></i> Alarm Settings</h2>
                   
                    <div class="form-group">
                        <label for="crypto-select"><i class="fas fa-coins"></i> Select Cryptocurrency</label>
                        <select id="crypto-select">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="BNB">Binance Coin (BNB)</option>
                            <option value="SOL">Solana (SOL)</option>
                            <option value="XRP">Ripple (XRP)</option>
                            <option value="ADA">Cardano (ADA)</option>
                            <option value="DOGE">Dogecoin (DOGE)</option>
                            <option value="DOT">Polkadot (DOT)</option>
                            <option value="AVAX">Avalanche (AVAX)</option>
                            <option value="LINK">Chainlink (LINK)</option>
                        </select>
                    </div>
                   
                    <div class="form-group">
                        <label><i class="fas fa-bell"></i> Alarm Type</label>
                        <div class="alarm-type">
                            <label>
                                <input type="radio" name="alarm-type" value="price" checked>
                                <span>Specific Price</span>
                            </label>
                            <label>
                                <input type="radio" name="alarm-type" value="percentage">
                                <span>Percentage Change</span>
                            </label>
                        </div>
                    </div>
                   
                    <div class="form-group" id="price-alarm-group">
                        <label for="alarm-price"><i class="fas fa-dollar-sign"></i> Set Alarm Price (USD)</label>
                        <input type="number" id="alarm-price" step="0.01" min="0" placeholder="Enter target price">
                    </div>
                   
                    <div class="form-group" id="percentage-alarm-group" style="display: none;">
                        <label><i class="fas fa-percentage"></i> Set Percentage Change</label>
                        <div class="percentage-input">
                            <input type="number" id="percentage-change" step="0.1" min="0.1" max="100" placeholder="Percentage">
                            <select id="percentage-direction">
                                <option value="above">Above Current</option>
                                <option value="below">Below Current</option>
                            </select>
                        </div>
                    </div>
                   
                    <button id="set-alarm" class="btn"><i class="fas fa-plus-circle"></i> Add Alarm</button>
                </div>
               
                <div class="control-group">
                    <h2><i class="fas fa-music"></i> Sound Settings</h2>
                   
                    <div class="form-group">
                        <label for="alarm-tone"><i class="fas fa-file-audio"></i> Custom Alarm Tone</label>
                        <input type="file" id="alarm-tone" accept="audio/*">
                    </div>
                   
                    <div class="form-group">
                        <label><i class="fas fa-volume-up"></i> Alarm Volume</label>
                        <div class="volume-control">
                            <i class="fas fa-volume-down volume-icon"></i>
                            <input type="range" id="alarm-volume" min="0" max="1" step="0.1" value="0.7">
                            <i class="fas fa-volume-up volume-icon"></i>
                        </div>
                    </div>
                   
                    <button id="stop-alarm" class="btn btn-stop"><i class="fas fa-stop"></i> Stop Alarm</button>
                   
                    <div class="sound-test">
                        <p>Test alarm sound:</p>
                        <div class="sound-test-buttons">
                            <button id="test-sound" class="btn sound-test-btn"><i class="fas fa-play"></i> Play</button>
                            <button id="stop-test-sound" class="btn btn-stop sound-test-btn"><i class="fas fa-stop"></i> Stop</button>
                        </div>
                    </div>
                </div>
               
                <div class="control-group">
                    <h2><i class="fas fa-save"></i> Save & Load</h2>
                    <p>Save and load your alarm settings</p>
                    <div class="save-load-controls">
                        <button id="save-alarms" class="btn"><i class="fas fa-save"></i> Save Alarms</button>
                        <button id="load-alarms" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Load Alarms</button>
                    </div>
                </div>
            </div>
           
            <div class="alarm-table">
                <table>
                    <thead>
                        <tr>
                            <th>Cryptocurrency</th>
                            <th>Current Price</th>
                            <th>Alarm Status</th>
                            <th>Executed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="alarm-table-body">
                        <!-- Alarms will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
       
        <footer>
            <p>Real-time cryptocurrency price data provided by Binance API</p>
            <p>Alarms work even in background tabs - notifications and sounds will trigger</p>
        </footer>
    </div>
   
    <div class="notification" id="alarm-notification">
        <i class="fas fa-bell"></i>
        <span id="notification-text">Alarm triggered!</span>
    </div>
   
    <audio id="alarm-sound" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    
    <div class="debug-info" id="debug-info"></div>
   
    <script>
        // DOM Elements
        const authOverlay = document.getElementById('auth-overlay');
        const appContainer = document.getElementById('app-container');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupConfirm = document.getElementById('signup-confirm');
        const signupError = document.getElementById('signup-error');
        const signupSuccess = document.getElementById('signup-success');
        
        const cryptoSelect = document.getElementById('crypto-select');
        const alarmPriceInput = document.getElementById('alarm-price');
        const setAlarmBtn = document.getElementById('set-alarm');
        const alarmToneInput = document.getElementById('alarm-tone');
        const alarmVolume = document.getElementById('alarm-volume');
        const stopAlarmBtn = document.getElementById('stop-alarm');
        const alarmTableBody = document.getElementById('alarm-table-body');
        const alarmSound = document.getElementById('alarm-sound');
        const alarmNotification = document.getElementById('alarm-notification');
        const notificationText = document.getElementById('notification-text');
        const priceAlarmGroup = document.getElementById('price-alarm-group');
        const percentageAlarmGroup = document.getElementById('percentage-alarm-group');
        const percentageChange = document.getElementById('percentage-change');
        const percentageDirection = document.getElementById('percentage-direction');
        const alarmTypeRadios = document.querySelectorAll('input[name="alarm-type"]');
        const testSoundBtn = document.getElementById('test-sound');
        const stopTestSoundBtn = document.getElementById('stop-test-sound');
        const saveAlarmsBtn = document.getElementById('save-alarms');
        const loadAlarmsBtn = document.getElementById('load-alarms');
        const debugInfo = document.getElementById('debug-info');
        const statusMessage = document.getElementById('status-message');
       
        // State
        let alarms = [];
        let activeAlarm = null;
        let priceData = {};
        let ws = null;
        let trackedSymbols = new Set();
        let audioContext = null;
        let currentUser = null;
        let retryCounters = {};

        // User Authentication Functions
        function switchToLogin() {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
            signupError.textContent = '';
            signupSuccess.textContent = '';
        }

        function switchToSignup() {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
            loginError.textContent = '';
        }

        function loginUser() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            
            if (!email || !password) {
                loginError.textContent = 'Please fill in all fields';
                return;
            }
            
            // Get user data from localStorage
            const userKey = `user_${email}`;
            const userData = localStorage.getItem(userKey);
            
            if (!userData) {
                loginError.textContent = 'Account not found. Please sign up.';
                return;
            }
            
            const user = JSON.parse(userData);
            
            if (user.password !== password) {
                loginError.textContent = 'Incorrect password';
                return;
            }
            
            // Login successful
            currentUser = email;
            userEmail.textContent = email;
            userInfo.style.display = 'flex';
            authOverlay.style.display = 'none';
            appContainer.style.display = 'block';
            
            // Load user's alarms
            alarms = user.alarms || [];
            renderAlarms();
            
            // Initialize alarms
            alarms.forEach(alarm => {
                trackSymbol(alarm.symbol);
                if (alarm.active) {
                    const row = document.querySelector(`tr[data-id="${alarm.id}"]`);
                    if (row) {
                        const indicator = row.querySelector('.status-indicator');
                        if (indicator) {
                            indicator.classList.toggle('status-active', alarm.active);
                        }
                    }
                }
            });
            
            // Initialize WebSocket
            setupWebSocket();
        }

        function signupUser() {
            const email = signupEmail.value.trim();
            const password = signupPassword.value.trim();
            const confirmPassword = signupConfirm.value.trim();
            
            if (!email || !password || !confirmPassword) {
                signupError.textContent = 'Please fill in all fields';
                return;
            }
            
            if (password !== confirmPassword) {
                signupError.textContent = 'Passwords do not match';
                return;
            }
            
            if (password.length < 6) {
                signupError.textContent = 'Password must be at least 6 characters';
                return;
            }
            
            // Check if user already exists
            const userKey = `user_${email}`;
            if (localStorage.getItem(userKey)) {
                signupError.textContent = 'Email already registered';
                return;
            }
            
            // Create new user
            const user = {
                email,
                password,
                alarms: []
            };
            
            // Save user
            localStorage.setItem(userKey, JSON.stringify(user));
            
            signupError.textContent = '';
            signupSuccess.textContent = 'Account created successfully!';
            
            // Auto login after successful signup
            setTimeout(() => {
                loginEmail.value = email;
                loginPassword.value = password;
                loginUser();
            }, 1500);
        }

        function logoutUser() {
            currentUser = null;
            alarms = [];
            alarmTableBody.innerHTML = '';
            userInfo.style.display = 'none';
            appContainer.style.display = 'none';
            authOverlay.style.display = 'flex';
            switchToLogin();
            
            // Close WebSocket connection
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // Save alarms to user's account
        function saveAlarms() {
            if (!currentUser) return;
            
            const userKey = `user_${currentUser}`;
            const userData = JSON.parse(localStorage.getItem(userKey));
            userData.alarms = alarms;
            localStorage.setItem(userKey, JSON.stringify(userData));
            
            showStatus('Alarms saved successfully!', '#92fe9d');
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: amount < 1 ? 4 : 2
            }).format(amount);
        }
        
        // Add alarm to table
        function addAlarmToTable(alarm) {
            const row = document.createElement('tr');
            row.dataset.id = alarm.id;
           
            // Crypto name and symbol
            const nameCell = document.createElement('td');
            nameCell.innerHTML = `
                <div class="crypto-name">
                    <strong>${alarm.crypto}</strong>
                    <span>${alarm.symbol}</span>
                </div>
            `;
           
            // Current price
            const priceCell = document.createElement('td');
            const priceDisplay = document.createElement('div');
            priceDisplay.className = 'price-display';
            priceDisplay.id = `price-${alarm.symbol}`;
            priceDisplay.textContent = 'Loading...';
            priceCell.appendChild(priceDisplay);
           
            // Alarm status
            const statusCell = document.createElement('td');
            const statusDisplay = document.createElement('div');
            statusDisplay.className = 'alarm-status';
           
            let alarmText = '';
            if (alarm.type === 'price') {
                alarmText = `Alarm at ${formatCurrency(alarm.value)}`;
            } else {
                const direction = alarm.direction === 'above' ? 'above' : 'below';
                alarmText = `${direction} ${alarm.value}%`;
            }
           
            statusDisplay.innerHTML = `
                <div class="status-indicator ${alarm.active ? 'status-active' : ''}"></div>
                <span>${alarmText}</span>
            `;
            statusCell.appendChild(statusDisplay);
           
            // Executed status
            const executedCell = document.createElement('td');
            executedCell.className = 'executed-status';
            executedCell.innerHTML = `<span class="${alarm.triggered ? 'executed-yes' : 'executed-no'}">${alarm.triggered ? 'Yes' : 'No'}</span>`;
           
            // Action buttons
            const actionCell = document.createElement('td');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'action-buttons';
           
            actionsDiv.innerHTML = `
                <button class="btn action-btn ${alarm.active ? 'btn-stop' : ''}" data-action="toggle">
                    <i class="fas ${alarm.active ? 'fa-pause' : 'fa-play'}"></i> ${alarm.active ? 'Pause' : 'Resume'}
                </button>
                <button class="btn action-btn btn-secondary" data-action="delete">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;
            actionCell.appendChild(actionsDiv);
           
            row.appendChild(nameCell);
            row.appendChild(priceCell);
            row.appendChild(statusCell);
            row.appendChild(executedCell);
            row.appendChild(actionCell);
            alarmTableBody.appendChild(row);
           
            // Add event listeners for action buttons
            const toggleBtn = row.querySelector('[data-action="toggle"]');
            const deleteBtn = row.querySelector('[data-action="delete"]');
           
            toggleBtn.addEventListener('click', () => toggleAlarm(alarm.id));
            deleteBtn.addEventListener('click', () => deleteAlarm(alarm.id));
            
            // Immediately fetch current price for this symbol
            fetchCurrentPrice(alarm.symbol);
        }
        
        // Render all alarms
        function renderAlarms() {
            alarmTableBody.innerHTML = '';
            alarms.forEach(alarm => {
                addAlarmToTable(alarm);
            });
        }
        
        // Update price display
        function updatePriceDisplay(symbol, price, prevPrice) {
            const display = document.getElementById(`price-${symbol}`);
            if (display) {
                display.textContent = formatCurrency(price);
               
                // Add animation class for price change
                display.classList.remove('price-up', 'price-down');
                if (prevPrice !== undefined) {
                    if (price > prevPrice) {
                        display.classList.add('price-up');
                    } else if (price < prevPrice) {
                        display.classList.add('price-down');
                    }
                }
            }
        }
        
        // Fetch current price via REST API
        async function fetchCurrentPrice(symbol) {
            const symbolFormatted = `${symbol}USDT`; // Format to Binance symbol
            
            // Initialize retry counter
            if (!retryCounters[symbol]) {
                retryCounters[symbol] = 0;
            }
            
            try {
                // Use the correct Binance API endpoint
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbolFormatted}`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Ensure valid price data
                if (!data || !data.price) {
                    throw new Error('Invalid price data from API');
                }
                
                const price = parseFloat(data.price);
                
                // Update price data
                if (priceData[symbol]) {
                    priceData[symbol].prevPrice = priceData[symbol].price;
                    priceData[symbol].price = price;
                } else {
                    priceData[symbol] = {
                        price: price,
                        prevPrice: price
                    };
                }
                
                // Reset retry counter on success
                retryCounters[symbol] = 0;
                
                // Update display immediately
                updatePriceDisplay(symbol, price, priceData[symbol].prevPrice);
                
                // Update debug info
                debugInfo.textContent = `Loaded ${symbol}: $${price}`;
            } catch (error) {
                console.error('Error fetching price:', error);
                const display = document.getElementById(`price-${symbol}`);
                if (display) {
                    display.textContent = 'Error loading, retrying...';
                    display.style.color = '#ff416c';
                    
                    // Update debug info
                    debugInfo.textContent = `Error loading ${symbol}: ${error.message}`;
                    
                    // Exponential backoff for retries
                    const retryDelay = Math.min(5000, 1000 * Math.pow(2, retryCounters[symbol]));
                    retryCounters[symbol]++;
                    
                    // Retry after delay
                    setTimeout(() => fetchCurrentPrice(symbol), retryDelay);
                }
            }
        }
        
        // Set up WebSocket connection
        function setupWebSocket() {
            // Close existing connection if open
            if (ws) {
                ws.close();
            }
           
            // Only connect if we have symbols to track
            if (trackedSymbols.size === 0) return;
           
            // Create stream URL
            const streams = Array.from(trackedSymbols)
                .map(symbol => `${symbol.toLowerCase()}usdt@ticker`)
                .join('/');
           
            // Create new WebSocket connection
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
           
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const streamData = data.data;
                const symbol = streamData.s.replace('USDT', ''); // Remove USDT suffix
                const price = parseFloat(streamData.c);
               
                // Update price data
                if (priceData[symbol]) {
                    priceData[symbol].prevPrice = priceData[symbol].price;
                    priceData[symbol].price = price;
                } else {
                    priceData[symbol] = {
                        price: price,
                        prevPrice: price
                    };
                }
               
                // Update price display
                updatePriceDisplay(symbol, price, priceData[symbol].prevPrice);
               
                // Check alarms
                checkAlarms(symbol, price);
            };
           
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                debugInfo.textContent = `WebSocket error: ${error.message}`;
            };
           
            ws.onclose = () => {
                console.log('WebSocket closed');
                debugInfo.textContent = 'WebSocket closed. Reconnecting...';
                // Attempt to reconnect if closed unexpectedly
                setTimeout(setupWebSocket, 3000);
            };
        }
        
        // Add symbol to tracking
        function trackSymbol(symbol) {
            if (!trackedSymbols.has(symbol)) {
                trackedSymbols.add(symbol);
                setupWebSocket();
            }
        }
        
        // Set alarm
        function setAlarm() {
            if (!currentUser) return;
            
            const selectedOption = cryptoSelect.options[cryptoSelect.selectedIndex];
            const crypto = selectedOption.text.split(' (')[0];
            const symbol = cryptoSelect.value;
            const alarmType = document.querySelector('input[name="alarm-type"]:checked').value;
           
            let alarmValue, alarmDirection;
           
            if (alarmType === 'price') {
                alarmValue = parseFloat(alarmPriceInput.value);
                if (!alarmValue || alarmValue <= 0) {
                    showStatus('Please enter a valid price', '#ff416c');
                    return;
                }
            } else {
                alarmValue = parseFloat(percentageChange.value);
                if (!alarmValue || alarmValue <= 0 || alarmValue > 100) {
                    showStatus('Please enter a valid percentage (0.1-100)', '#ff416c');
                    return;
                }
                alarmDirection = percentageDirection.value;
            }
           
            // Create alarm object
            const alarm = {
                id: Date.now(),
                crypto,
                symbol,
                type: alarmType,
                value: alarmValue,
                direction: alarmDirection,
                active: true,
                triggered: false,
                basePrice: null // Will be set when we get the first price
            };
           
            // Add to alarms array
            alarms.push(alarm);
           
            // Add to table
            addAlarmToTable(alarm);
           
            // Start tracking symbol
            trackSymbol(symbol);
           
            // Reset form
            alarmPriceInput.value = '';
            percentageChange.value = '';
           
            // Save alarms
            saveAlarms();
            
            // Show success message
            showStatus('Alarm added successfully!', '#92fe9d');
        }
        
        // Check if any alarms should be triggered
        function checkAlarms(symbol, currentPrice) {
            alarms.forEach(alarm => {
                if (alarm.symbol === symbol && alarm.active && !alarm.triggered) {
                    // Set base price for percentage alarms if not set
                    if (alarm.type === 'percentage' && alarm.basePrice === null) {
                        alarm.basePrice = currentPrice;
                        return; // Skip check for this update
                    }
                   
                    let shouldTrigger = false;
                   
                    if (alarm.type === 'price') {
                        // Check if price has reached alarm level
                        if ((alarm.value >= priceData[symbol].prevPrice && alarm.value <= currentPrice) ||
                            (alarm.value <= priceData[symbol].prevPrice && alarm.value >= currentPrice)) {
                            shouldTrigger = true;
                        }
                    } else if (alarm.type === 'percentage') {
                        // Calculate percentage change
                        const basePrice = alarm.basePrice || priceData[symbol].price;
                        const percentageChange = ((currentPrice - basePrice) / basePrice) * 100;
                       
                        if (alarm.direction === 'above' && percentageChange >= alarm.value) {
                            shouldTrigger = true;
                        } else if (alarm.direction === 'below' && percentageChange <= -alarm.value) {
                            shouldTrigger = true;
                        }
                    }
                   
                    if (shouldTrigger) {
                        triggerAlarm(alarm, currentPrice);
                        alarm.triggered = true;
                        alarm.active = false;
                        saveAlarms();
                        updateAlarmRow(alarm.id);
                    }
                }
            });
        }
        
        // Trigger alarm
        function triggerAlarm(alarm, currentPrice) {
            // Set as active alarm
            activeAlarm = alarm;
           
            // Update UI
            const row = document.querySelector(`tr[data-id="${alarm.id}"]`);
            if (row) {
                row.classList.add('alarm-active');
                const indicator = row.querySelector('.status-indicator');
                if (indicator) {
                    indicator.classList.add('status-active');
                }
            }
           
            // Show notification
            let message = '';
            if (alarm.type === 'price') {
                message = `${alarm.crypto} reached ${formatCurrency(alarm.value)}! Current: ${formatCurrency(currentPrice)}`;
            } else {
                const direction = alarm.direction === 'above' ? 'above' : 'below';
                message = `${alarm.crypto} changed ${direction} ${alarm.value}%! Current: ${formatCurrency(currentPrice)}`;
            }
           
            notificationText.textContent = message;
            alarmNotification.classList.add('show');
           
            // Play alarm sound
            try {
                alarmSound.volume = parseFloat(alarmVolume.value);
                alarmSound.currentTime = 0;
                alarmSound.play().catch(e => {
                    console.log('Play prevented, trying to resume audio context');
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            alarmSound.play();
                        });
                    }
                });
            } catch (e) {
                console.error('Error playing alarm sound:', e);
            }
           
            // Auto hide notification after 5 seconds
            setTimeout(() => {
                alarmNotification.classList.remove('show');
            }, 5000);
        }
        
        // Stop alarm
        function stopAlarm() {
            if (activeAlarm) {
                // Reset alarm
                activeAlarm.active = false;
               
                // Update UI
                const row = document.querySelector(`tr[data-id="${activeAlarm.id}"]`);
                if (row) {
                    row.classList.remove('alarm-active');
                    const indicator = row.querySelector('.status-indicator');
                    if (indicator) {
                        indicator.classList.remove('status-active');
                    }
                }
               
                // Stop sound
                alarmSound.pause();
                alarmSound.currentTime = 0;
               
                // Hide notification
                alarmNotification.classList.remove('show');
               
                activeAlarm = null;
            }
        }
        
        // Load custom alarm tone
        function loadCustomTone(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    alarmSound.src = e.target.result;
                };
                reader.readAsDataURL(file);
                showStatus('Custom alarm sound loaded!', '#00c9ff');
            }
        }
        
        // Adjust volume
        function adjustVolume() {
            alarmSound.volume = parseFloat(alarmVolume.value);
        }
        
        // Toggle alarm type UI
        function toggleAlarmType() {
            const alarmType = document.querySelector('input[name="alarm-type"]:checked').value;
           
            if (alarmType === 'price') {
                priceAlarmGroup.style.display = 'block';
                percentageAlarmGroup.style.display = 'none';
            } else {
                priceAlarmGroup.style.display = 'none';
                percentageAlarmGroup.style.display = 'block';
            }
        }
        
        // Test sound
        function testSound() {
            try {
                alarmSound.volume = parseFloat(alarmVolume.value);
                alarmSound.currentTime = 0;
                alarmSound.play().catch(e => {
                    console.log('Play prevented, trying to resume audio context');
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            alarmSound.play();
                        });
                    }
                });
            } catch (e) {
                console.error('Error playing test sound:', e);
                showStatus('Error playing sound. Enable audio and try again.', '#ff416c');
            }
        }
        
        // Stop test sound
        function stopTestSound() {
            alarmSound.pause();
            alarmSound.currentTime = 0;
        }
        
        // Toggle alarm active state
        function toggleAlarm(id) {
            const alarm = alarms.find(a => a.id === id);
            if (alarm) {
                alarm.active = !alarm.active;
                saveAlarms();
                updateAlarmRow(id);
                showStatus(`Alarm ${alarm.active ? 'activated' : 'paused'}`, alarm.active ? '#92fe9d' : '#ff416c');
            }
        }
        
        // Delete alarm
        function deleteAlarm(id) {
            const alarm = alarms.find(a => a.id === id);
            alarms = alarms.filter(a => a.id !== id);
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                row.remove();
            }
            saveAlarms();
            showStatus(`Alarm for ${alarm.crypto} deleted`, '#ff416c');
        }
        
        // Update alarm row in table
        function updateAlarmRow(id) {
            const alarm = alarms.find(a => a.id === id);
            if (!alarm) return;
           
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
           
            // Update status indicator
            const indicator = row.querySelector('.status-indicator');
            if (indicator) {
                indicator.classList.toggle('status-active', alarm.active);
            }
           
            // Update executed status
            const executedCell = row.querySelector('.executed-status');
            if (executedCell) {
                executedCell.innerHTML = `<span class="${alarm.triggered ? 'executed-yes' : 'executed-no'}">${alarm.triggered ? 'Yes' : 'No'}</span>`;
            }
           
            // Update toggle button
            const toggleBtn = row.querySelector('[data-action="toggle"]');
            if (toggleBtn) {
                toggleBtn.innerHTML = `<i class="fas ${alarm.active ? 'fa-pause' : 'fa-play'}"></i> ${alarm.active ? 'Pause' : 'Resume'}`;
                toggleBtn.className = `btn action-btn ${alarm.active ? 'btn-stop' : ''}`;
            }
        }
        
        // Show status message
        function showStatus(message, color) {
            statusMessage.textContent = message;
            statusMessage.style.backgroundColor = color;
            statusMessage.classList.add('show');
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }
        
        // Initialize
        function init() {
            // Initialize audio context for background tab support
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
            
            // Set up authentication event listeners
            loginTab.addEventListener('click', switchToLogin);
            signupTab.addEventListener('click', switchToSignup);
            loginBtn.addEventListener('click', loginUser);
            signupBtn.addEventListener('click', signupUser);
            logoutBtn.addEventListener('click', logoutUser);
            
            // Allow form submission with Enter key
            loginForm.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });
            
            signupForm.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signupUser();
            });
            
            // Set up alarm event listeners
            setAlarmBtn.addEventListener('click', setAlarm);
            stopAlarmBtn.addEventListener('click', stopAlarm);
            alarmToneInput.addEventListener('change', loadCustomTone);
            alarmVolume.addEventListener('input', adjustVolume);
            testSoundBtn.addEventListener('click', testSound);
            stopTestSoundBtn.addEventListener('click', stopTestSound);
            saveAlarmsBtn.addEventListener('click', saveAlarms);
            loadAlarmsBtn.addEventListener('click', saveAlarms); // Reusing save for demo
            
            // Set up alarm type toggle
            alarmTypeRadios.forEach(radio => {
                radio.addEventListener('change', toggleAlarmType);
            });
            
            // Initialize alarm sound
            alarmSound.volume = parseFloat(alarmVolume.value);
            
            // Create demo account
            const demoUserKey = 'user_demo@crypto.com';
            if (!localStorage.getItem(demoUserKey)) {
                const demoUser = {
                    email: 'demo@crypto.com',
                    password: 'password123',
                    alarms: []
                };
                localStorage.setItem(demoUserKey, JSON.stringify(demoUser));
            }
            
            // Auto-login for demo
            loginEmail.value = 'demo@crypto.com';
            loginPassword.value = 'password123';
            loginUser();
        }
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>